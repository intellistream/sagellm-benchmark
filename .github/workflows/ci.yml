# CI workflow for sagellm-benchmark
#
# Jobs:
# 1. code-quality: Pre-commit hooks (format, lint, type check)
# 2. version-check: Ensure ruff version matches pre-commit config
# 3. version-source-guard: Validate _version.py single source of truth
# 4. test: pytest with coverage (Python 3.10, 3.11, 3.12)
# 5. build: Verify package builds correctly

name: CI

on:
  push:
    branches: [main, main-dev, dev, 'feature/*']
    paths:
      - '**.py'
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
      - '.pre-commit-config.yaml'
  pull_request:
    branches: [main, main-dev, dev]
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_DEFAULT_VERSION: "3.11"

jobs:
  # Job 1: Code quality with pre-commit (MANDATORY APPROACH A)
  code-quality:
    name: Code Quality (pre-commit)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff

      - name: Configure China mirrors
        run: |
          # Configure pip to use Tsinghua mirror
          mkdir -p ~/.pip
          cat > ~/.pip/pip.conf << EOF
          [global]
          index-url = https://pypi.tuna.tsinghua.edu.cn/simple
          trusted-host = pypi.tuna.tsinghua.edu.cn
          EOF

          # Configure HuggingFace mirror
          export HF_ENDPOINT=https://hf-mirror.com
          echo "HF_ENDPOINT=https://hf-mirror.com" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}
          cache: 'pip'

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install tools
        run: |
          pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit (changed files for PR)
        if: github.event_name == 'pull_request'
        run: |
          CHANGED=$(git diff --name-only --diff-filter=ACM origin/${{ github.base_ref }}...HEAD | grep -E '\.py$' || true)
          if [ -z "$CHANGED" ]; then
            echo "No Python files changed, skipping"
            exit 0
          fi
          echo "$CHANGED" | xargs pre-commit run --files

      - name: Run pre-commit (all files)
        if: github.event_name != 'pull_request'
        run: pre-commit run --all-files

  # ─────────────────────────────────────────────────────────────────
  # Version Check - Ensure tool versions match between local and CI
  # ─────────────────────────────────────────────────────────────────
  version-check:
    name: Check Tool Versions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Check ruff version consistency
        run: |
          # Get local ruff version
          LOCAL_RUFF=$(ruff --version | awk '{print $2}')
          echo "Local ruff: $LOCAL_RUFF"

          # Get pre-commit config ruff version
          if [ -f .pre-commit-config.yaml ]; then
            PRECOMMIT_RUFF=$(grep -A 2 'ruff-pre-commit' .pre-commit-config.yaml | grep 'rev:' | awk '{print $2}' | sed 's/v//')
            echo "Pre-commit ruff: v$PRECOMMIT_RUFF"

            # Compare versions
            if [ "$LOCAL_RUFF" != "$PRECOMMIT_RUFF" ]; then
              echo "::error::❌ Version mismatch! Local ruff ($LOCAL_RUFF) != pre-commit ruff (v$PRECOMMIT_RUFF)"
              echo ""
              echo "To fix this, run:"
              echo "  pip install ruff==$PRECOMMIT_RUFF"
              echo "Or update .pre-commit-config.yaml:"
              echo "  pre-commit autoupdate"
              exit 1
            fi

            echo "✅ Versions match: $LOCAL_RUFF"
          else
            echo "⚠️  No .pre-commit-config.yaml found, skipping check"
          fi

  # ─────────────────────────────────────────────────────────────────
  # Version Source Guard - Validate _version.py single source of truth
  # (merged from version-source-guard.yml)
  # ─────────────────────────────────────────────────────────────────
  version-source-guard:
    name: Version Source Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate single version source
        run: |
          python3 - <<'PY'
          from __future__ import annotations

          import re
          import sys
          from pathlib import Path

          root = Path('.')
          pyproject = root / 'pyproject.toml'
          if not pyproject.exists():
              print('No pyproject.toml found, skip version source guard.')
              raise SystemExit(0)

          if sys.version_info >= (3, 11):
              import tomllib
          else:
              raise RuntimeError('Python 3.11+ is required for tomllib')

          data = tomllib.loads(pyproject.read_text(encoding='utf-8'))

          project = data.get('project', {})
          if 'version' in project:
              raise SystemExit("[FAIL] project.version must not be hardcoded")

          dynamic = project.get('dynamic', [])
          if 'version' not in dynamic:
              raise SystemExit("[FAIL] [project].dynamic must include 'version'")

          attr = (
              data.get('tool', {})
              .get('setuptools', {})
              .get('dynamic', {})
              .get('version', {})
              .get('attr')
          )
          if not attr or not attr.endswith('._version.__version__'):
              raise SystemExit(
                  '[FAIL] [tool.setuptools.dynamic].version.attr must point to <package>._version.__version__'
              )

          src = root / 'src'
          if not src.exists():
              print('No src/ directory found, skip package file checks.')
              raise SystemExit(0)

          package_dirs = [
              p for p in src.iterdir() if p.is_dir() and (p / '__init__.py').exists() and not p.name.endswith('.egg-info')
          ]
          if not package_dirs:
              print('No package with __init__.py found under src/, skip package file checks.')
              raise SystemExit(0)

          errors: list[str] = []
          for package_dir in package_dirs:
              package = package_dir.name
              version_file = package_dir / '_version.py'
              init_file = package_dir / '__init__.py'

              if not version_file.exists():
                  errors.append(f'[FAIL] missing {version_file.as_posix()}')
                  continue

              version_text = version_file.read_text(encoding='utf-8')
              if not re.search(r'^__version__\s*=\s*["\'][^"\']+["\']\s*$', version_text, re.M):
                  errors.append(f'[FAIL] {version_file.as_posix()} must define __version__ = "X.Y.Z.N"')

              init_text = init_file.read_text(encoding='utf-8')
              import_patterns = [
                  rf'^from\s+{re.escape(package)}\._version\s+import\s+__version__\s*$',
                  r'^from\s+\._version\s+import\s+__version__\s*$',
              ]
              if not any(re.search(p, init_text, re.M) for p in import_patterns):
                  errors.append(
                      f'[FAIL] {init_file.as_posix()} must import __version__ from _version.py'
                  )

              if re.search(r'^__version__\s*=\s*["\'][^"\']+["\']\s*$', init_text, re.M):
                  errors.append(
                      f'[FAIL] {init_file.as_posix()} must not hardcode __version__'
                  )

          if errors:
              print('\n'.join(errors))
              raise SystemExit(1)

          print('[PASS] Version source of truth checks passed.')
          PY

  # Job 2: Unit tests with coverage
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: code-quality  # Run after code quality checks pass
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            -v \
            --cov=sagellm_benchmark \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=70

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true  # Don't block CI if codecov fails

  # Job 3: Build verification
  build:
    name: Build Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
