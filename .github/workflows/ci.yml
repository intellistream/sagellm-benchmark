# CI workflow for sagellm-benchmark
# Uses pre-commit for code quality (Approach A - MANDATORY)
#
# Jobs:
# 1. code-quality: Pre-commit hooks (format, lint, type check)
# 2. test: pytest with coverage (Python 3.10, 3.11, 3.12)
# 3. build: Verify package builds correctly

name: CI

on:
  push:
    branches: [main, main-dev, dev, 'feature/*']
    paths:
      - '**.py'
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
      - '.pre-commit-config.yaml'
  pull_request:
    branches: [main, main-dev, dev]
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_DEFAULT_VERSION: "3.11"

jobs:
  # Job 1: Code quality with pre-commit (MANDATORY APPROACH A)
  code-quality:
    name: Code Quality (pre-commit)
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff

      - name: Configure China mirrors
        run: |
          # Configure pip to use Tsinghua mirror
          mkdir -p ~/.pip
          cat > ~/.pip/pip.conf << EOF
          [global]
          index-url = https://pypi.tuna.tsinghua.edu.cn/simple
          trusted-host = pypi.tuna.tsinghua.edu.cn
          EOF

          # Configure HuggingFace mirror
          export HF_ENDPOINT=https://hf-mirror.com
          echo "HF_ENDPOINT=https://hf-mirror.com" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}
          cache: 'pip'

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install tools
        run: |
          pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit (changed files for PR)
        if: github.event_name == 'pull_request'
        run: |
          CHANGED=$(git diff --name-only --diff-filter=ACM origin/${{ github.base_ref }}...HEAD | grep -E '\.py$' || true)
          if [ -z "$CHANGED" ]; then
            echo "No Python files changed, skipping"
            exit 0
          fi
          echo "$CHANGED" | xargs pre-commit run --files

      - name: Run pre-commit (all files)
        if: github.event_name != 'pull_request'
        run: pre-commit run --all-files

  # ─────────────────────────────────────────────────────────────────
  # Version Check - Ensure tool versions match between local and CI
  # ─────────────────────────────────────────────────────────────────
  version-check:
    name: Check Tool Versions
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Check ruff version consistency
        run: |
          # Get local ruff version
          LOCAL_RUFF=$(ruff --version | awk '{print $2}')
          echo "Local ruff: $LOCAL_RUFF"

          # Get pre-commit config ruff version
          if [ -f .pre-commit-config.yaml ]; then
            PRECOMMIT_RUFF=$(grep -A 2 'ruff-pre-commit' .pre-commit-config.yaml | grep 'rev:' | awk '{print $2}' | sed 's/v//')
            echo "Pre-commit ruff: v$PRECOMMIT_RUFF"

            # Compare versions
            if [ "$LOCAL_RUFF" != "$PRECOMMIT_RUFF" ]; then
              echo "::error::❌ Version mismatch! Local ruff ($LOCAL_RUFF) != pre-commit ruff (v$PRECOMMIT_RUFF)"
              echo ""
              echo "To fix this, run:"
              echo "  pip install ruff==$PRECOMMIT_RUFF"
              echo "Or update .pre-commit-config.yaml:"
              echo "  pre-commit autoupdate"
              exit 1
            fi

            echo "✅ Versions match: $LOCAL_RUFF"
          else
            echo "⚠️  No .pre-commit-config.yaml found, skipping check"
          fi

  # Job 2: Unit tests with coverage
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: self-hosted
    needs: code-quality  # Run after code quality checks pass
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            -v \
            --cov=sagellm_benchmark \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=70

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true  # Don't block CI if codecov fails

  # Job 3: Build verification
  build:
    name: Build Package
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
