#!/bin/bash
# Pre-commit hook for sageVDB
# Runs basic code quality checks before allowing commits

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ” Running pre-commit checks...${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Check for trailing whitespace
echo -e "${YELLOW}Checking for trailing whitespace...${NC}"
if git diff --cached --check --diff-filter=ACM; then
    echo -e "${GREEN}âœ“ No trailing whitespace${NC}"
else
    echo -e "${RED}âœ— Found trailing whitespace. Please fix before committing.${NC}"
    exit 1
fi

# Check for large files (>5MB)
echo -e "${YELLOW}Checking for large files...${NC}"
max_size=5242880  # 5MB in bytes
large_files=$(git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt "$max_size" ]; then
            echo "$file ($((size/1024/1024))MB)"
        fi
    fi
done)

if [ -n "$large_files" ]; then
    echo -e "${RED}âœ— Large files detected (>5MB):${NC}"
    echo "$large_files"
    echo -e "${YELLOW}Consider using Git LFS or excluding these files.${NC}"
    exit 1
else
    echo -e "${GREEN}âœ“ No large files${NC}"
fi

# Check for common debug statements in Python files
echo -e "${YELLOW}Checking for debug statements...${NC}"
debug_found=false
git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | while read file; do
    if git diff --cached "$file" | grep -E '^\+.*\b(print|pdb\.set_trace|breakpoint)\(' > /dev/null; then
        if [ "$debug_found" = false ]; then
            echo -e "${YELLOW}âš   Warning: Debug statements found in:${NC}"
            debug_found=true
        fi
        echo "  - $file"
    fi
done

echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ“ Pre-commit checks passed!${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit 0
