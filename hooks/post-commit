#!/usr/bin/env bash
# Post-commit hook for sageLLM repositories
# Automatically bumps version after each commit (if not already updated)
# This avoids the pre-push hook complexity and misleading error messages

set -eo pipefail

# Skip if this is an amend (we already handled it)
if [ -f ".git/SAGE_POST_COMMIT_RUNNING" ]; then
    exit 0
fi

# Skip if disabled
if [ "${SAGE_SKIP_VERSION_BUMP:-0}" = "1" ]; then
    exit 0
fi

bump_version() {
    local v="$1"
    if [[ "$v" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
        echo "${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}.$((BASH_REMATCH[4] + 1))"
        return 0
    fi
    if [[ "$v" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
        echo "${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}.1"
        return 0
    fi
    return 1
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find version files
version_files=()
if [ -f "pyproject.toml" ]; then
    version_files+=("pyproject.toml")
fi

# Detect which __init__.py exists
for pkg in sagellm sagellm_protocol sagellm_backend sagellm_core sagellm_control sagellm_gateway sagellm_kv_cache sagellm_comm sagellm_compression sagellm_benchmark; do
    if [ -f "src/${pkg}/__init__.py" ]; then
        version_files+=("src/${pkg}/__init__.py")
        break
    fi
done

if [ ${#version_files[@]} -eq 0 ]; then
    # No version files found, nothing to do
    exit 0
fi

# Check if version was updated in this commit
version_updated=false
for vfile in "${version_files[@]}"; do
    if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "^$vfile$"; then
        version_updated=true
        break
    fi
done

if [ "$version_updated" = true ]; then
    # Version already updated, nothing to do
    exit 0
fi

# Get current version
current_version=""
if [ -f "pyproject.toml" ]; then
    current_version=$(grep '^version = ' pyproject.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
fi

if [ -z "$current_version" ]; then
    exit 0
fi

# Bump version
if ! new_version=$(bump_version "$current_version"); then
    echo -e "${YELLOW}‚ö†Ô∏è  Could not auto-bump version (invalid format: $current_version)${NC}"
    exit 0
fi

echo -e "${BLUE}üì¶ Auto-bumping version: $current_version ‚Üí $new_version${NC}"

# Create lock file to prevent recursion
touch .git/SAGE_POST_COMMIT_RUNNING

# Update version in files
if [ -f "pyproject.toml" ]; then
    sed -i "s/^version = \".*\"/version = \"$new_version\"/" pyproject.toml
    git add pyproject.toml
fi

# Update __init__.py if exists
for vfile in "${version_files[@]}"; do
    if [[ "$vfile" == *"__init__.py" ]]; then
        sed -i "s/__version__ = \".*\"/__version__ = \"$new_version\"/" "$vfile"
        git add "$vfile"
    fi
done

# Amend the commit with version update
git commit --amend --no-edit --no-verify

# Remove lock file
rm -f .git/SAGE_POST_COMMIT_RUNNING

echo -e "${GREEN}‚úì Version bumped to $new_version (commit amended)${NC}"

exit 0
