#!/bin/bash
# Pre-push hook managed by sage-pypi-publisher
# Auto-detects version updates and offers to build/upload to PyPI

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

PACKAGE_NAME=$(grep -oP '^name = "\K[^"]+' pyproject.toml 2>/dev/null || echo "unknown")

check_pypi_version_exists() {
    if [ "$PACKAGE_NAME" = "unknown" ]; then
        return 2
    fi
    if command -v python3 &> /dev/null; then
        python3 - "$PACKAGE_NAME" "$CURRENT_VERSION" <<'PY'
import json
import sys
import urllib.request

package = sys.argv[1]
version = sys.argv[2]
try:
    with urllib.request.urlopen(f"https://pypi.org/pypi/{package}/json", timeout=5) as resp:
        data = json.load(resp)
    releases = data.get("releases", {})
    sys.exit(0 if version in releases else 1)
except Exception:
    sys.exit(2)
PY
        return $?
    elif command -v curl &> /dev/null; then
        curl -fsSL "https://pypi.org/pypi/${PACKAGE_NAME}/json" | grep -q "\"${CURRENT_VERSION}\""
        return $?
    else
        return 2
    fi
}

CURRENT_VERSION=$(grep -oP '^version = "\K[^"]+' pyproject.toml 2>/dev/null || echo "unknown")
if [ "$CURRENT_VERSION" = "unknown" ]; then
    echo -e "${YELLOW}No pyproject.toml found, skipping version check${NC}"
    exit 0
fi

if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
    echo -e "${YELLOW}First commit detected, skipping version check${NC}"
    exit 0
fi

VERSION_UPDATED=false
for i in {1..5}; do
    if git diff HEAD~$i HEAD -- pyproject.toml 2>/dev/null | grep -q '^[+-]version = '; then
        VERSION_UPDATED=true
        break
    fi
done

if [ "$VERSION_UPDATED" = true ]; then
    echo -e "${GREEN}âœ“ Version updated to ${CURRENT_VERSION}${NC}"
    PYPI_CHECK_RESULT=0
    check_pypi_version_exists
    PYPI_CHECK_RESULT=$?
    if [ "$PYPI_CHECK_RESULT" -eq 0 ]; then
        echo -e "${YELLOW}âš  ${PACKAGE_NAME} ${CURRENT_VERSION} already exists on PyPI${NC}"
        echo -e "${BLUE}What would you like to do?${NC}"
        echo -e "  ${GREEN}[u]${NC} Update version now (interactive)"
        echo -e "  ${YELLOW}[y]${NC} Continue anyway"
        echo -e "  ${RED}[c]${NC} Cancel push"
        echo -n "Your choice [u/y/c]: "
        read -r pypi_resp </dev/tty

        if [[ "$pypi_resp" =~ ^[Uu]$ ]]; then
            echo ""
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${BLUE}ğŸ“ Version Update${NC}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}Current: ${BLUE}${CURRENT_VERSION}${NC}"
            echo ""
            echo -e "${GREEN}Enter new version (e.g., 0.1.7, 1.0.0):${NC}"
            echo -n "New version: "
            read -r new_version </dev/tty

            if [[ ! "$new_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z0-9._-]+)?$ ]]; then
                echo -e "${RED}âœ— Invalid format. Expected: X.Y.Z${NC}"
                exit 1
            fi

            old_version="$CURRENT_VERSION"
            sed -i "s/version = \"${CURRENT_VERSION}\"/version = \"${new_version}\"/" pyproject.toml
            git add pyproject.toml
            git commit -m "chore: bump version to ${new_version}"
            CURRENT_VERSION="$new_version"
            echo ""
            echo -e "${GREEN}âœ“ ${BLUE}${old_version}${GREEN} â†’ ${BLUE}${new_version}${NC}"
        elif [[ "$pypi_resp" =~ ^[Cc]$ ]]; then
            echo -e "${YELLOW}Push cancelled${NC}"
            exit 1
        fi
    elif [ "$PYPI_CHECK_RESULT" -eq 2 ]; then
        if [ "$PACKAGE_NAME" = "unknown" ]; then
            echo -e "${YELLOW}âš  Unable to check PyPI (missing package name in pyproject.toml)${NC}"
        else
            echo -e "${YELLOW}âš  Unable to check PyPI for existing version (missing python3/curl or network issue)${NC}"
        fi
    fi
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}ğŸ“¦ Build and upload version ${CURRENT_VERSION} to PyPI?${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${GREEN}[y]${NC} Yes, build and upload to PyPI"
    echo -e "  ${YELLOW}[n]${NC} No, just push to GitHub"
    echo -e "  ${RED}[c]${NC} Cancel push"
    echo -n "Your choice [y/n/c]: "
    read -r response </dev/tty

    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}ğŸ”¨ Building package...${NC}"
        rm -rf dist/ wheelhouse/ 2>/dev/null || true

        if command -v sage-pypi-publisher &> /dev/null; then
            echo -e "${GREEN}Using sage-pypi-publisher (auto-detects build type)...${NC}"
            if sage-pypi-publisher build . --upload --no-dry-run; then
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${GREEN}âœ“ Successfully uploaded ${CURRENT_VERSION} to PyPI${NC}"
                echo -e "${GREEN}ğŸ”— https://pypi.org/project/isage-vdb/${CURRENT_VERSION}/${NC}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            else
                echo -e "${RED}âœ— Failed to upload to PyPI${NC}"
                echo -e "${YELLOW}Continue push anyway? [y/N]${NC}"
                read -r cont </dev/tty
                [[ ! "$cont" =~ ^[Yy]$ ]] && exit 1
            fi
        else
            echo -e "${YELLOW}âš  sage-pypi-publisher not found${NC}"
            echo -e "${YELLOW}Install: pip install sage-pypi-publisher${NC}"
            echo -e "${YELLOW}Continue push? [y/N]${NC}"
            read -r cont </dev/tty
            [[ ! "$cont" =~ ^[Yy]$ ]] && exit 1
        fi
    elif [[ "$response" =~ ^[Cc]$ ]]; then
        echo -e "${YELLOW}Push cancelled${NC}"
        exit 1
    else
        echo -e "${YELLOW}Skipping PyPI upload${NC}"
    fi
else
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âš   WARNING: Version not updated!${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}ğŸ“Œ Current version: ${BLUE}${CURRENT_VERSION}${NC}"
    echo ""
    echo -e "${BLUE}What would you like to do?${NC}"
    echo -e "  ${GREEN}[u]${NC} Update version now (interactive)"
    echo -e "  ${YELLOW}[y]${NC} Continue without version update"
    echo -e "  ${RED}[n]${NC} Cancel push"
    echo -n "Your choice [u/y/n]: "
    read -r response </dev/tty

    if [[ "$response" =~ ^[Uu]$ ]]; then
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BLUE}ğŸ“ Version Update${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}Current: ${BLUE}${CURRENT_VERSION}${NC}"
        echo ""
        echo -e "${GREEN}Enter new version (e.g., 0.1.4, 1.0.0):${NC}"
        echo -n "New version: "
        read -r new_version </dev/tty

        if [[ ! "$new_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z0-9._-]+)?$ ]]; then
            echo -e "${RED}âœ— Invalid format. Expected: X.Y.Z${NC}"
            exit 1
        fi

        sed -i "s/version = \"${CURRENT_VERSION}\"/version = \"${new_version}\"/" pyproject.toml
        git add pyproject.toml
        git commit -m "chore: bump version to ${new_version}"

        echo ""
        echo -e "${GREEN}âœ“ ${BLUE}${CURRENT_VERSION}${GREEN} â†’ ${BLUE}${new_version}${NC}"
        echo ""
        echo -e "${BLUE}ğŸ“¦ Build and upload to PyPI? [y/n]:${NC}"
        read -r upload_resp </dev/tty

        if [[ "$upload_resp" =~ ^[Yy]$ ]]; then
            rm -rf dist/ wheelhouse/ 2>/dev/null || true
            if command -v sage-pypi-publisher &> /dev/null; then
                sage-pypi-publisher build . --upload --no-dry-run
                echo -e "${GREEN}âœ“ Uploaded ${new_version} to PyPI${NC}"
            fi
        fi
        exit 0
    elif [[ "$response" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Continuing without version update${NC}"
    else
        echo -e "${YELLOW}Push cancelled${NC}"
        exit 1
    fi
fi

exit 0
