#!/usr/bin/env bash
# Pre-push hook for sageLLM repositories
# Only handles PyPI upload (version bump is now done by post-commit hook)

set -eo pipefail

# Check if PyPI credentials are available (via ~/.pypirc or PYPI_TOKEN env var)
has_pypi_credentials() {
    if [ -f "$HOME/.pypirc" ] && grep -q '^\[pypi\]' "$HOME/.pypirc"; then
        return 0
    fi
    if [ -n "${PYPI_TOKEN:-}" ]; then
        return 0
    fi
    return 1
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

INTERACTIVE_PUSH=${SAGE_INTERACTIVE_PUSH:-0}

# Read stdin (contains: local_ref local_sha remote_ref remote_sha)
while read local_ref local_sha remote_ref remote_sha; do
    # Skip if deleting a branch
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        exit 0
    fi

    # Skip if no pyproject.toml (not a Python package)
    if [ ! -f "pyproject.toml" ]; then
        exit 0
    fi

    # Get current version
    current_version=$(grep '^version = ' pyproject.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

    if [ -z "$current_version" ]; then
        exit 0
    fi

    echo -e "${GREEN}‚úì Pushing version $current_version${NC}"

    # Ask if should upload to PyPI
    if [ "$INTERACTIVE_PUSH" = "1" ]; then
        echo -e "${YELLOW}üì¶ Build and upload to PyPI? [y/n]: ${NC}"
        read -r choice </dev/tty
    else
        # Non-interactive: auto-upload if credentials available
        if has_pypi_credentials && command -v sage-pypi-publisher &> /dev/null; then
            choice="y"
        else
            choice="n"
        fi
    fi

    if [ "$choice" = "y" ] || [ "$choice" = "Y" ]; then
        if ! has_pypi_credentials; then
            echo -e "${YELLOW}‚ö†Ô∏è  PyPI credentials not found (~/.pypirc or PYPI_TOKEN), skipping upload${NC}"
        elif ! command -v sage-pypi-publisher &> /dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  sage-pypi-publisher not found, skipping PyPI upload${NC}"
            echo -e "${YELLOW}    Install with: pip install isage-pypi-publisher${NC}"
        else
            echo -e "${BLUE}üî® Building and uploading to PyPI...${NC}"

            # Build and upload
            if sage-pypi-publisher build . --upload --no-dry-run; then
                echo -e "${GREEN}‚úì Successfully uploaded to PyPI${NC}"
            else
                echo -e "${RED}‚ùå PyPI upload failed${NC}"
                if [ "$INTERACTIVE_PUSH" = "1" ]; then
                    echo -e "${YELLOW}Continue pushing to GitHub anyway? [y/n]: ${NC}"
                    read -r continue_choice </dev/tty
                    if [ "$continue_choice" != "y" ] && [ "$continue_choice" != "Y" ]; then
                        echo -e "${RED}Push cancelled${NC}"
                        exit 1
                    fi
                fi
            fi
        fi
    fi
done

# Let the original push continue
exit 0
